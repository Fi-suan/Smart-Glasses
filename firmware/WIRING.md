# Smart Glasses - Схема подключения

## Обзор компонентов

```
+------------------+     +------------------+     +------------------+
|    NodeMCU       |     |   ESP32-CAM      |     |  DFPlayer Mini   |
|   (ESP8266)      |     |                  |     |   (MP3-TF-16P)   |
|                  |     |                  |     |                  |
| Используется     |     | Основной мозг    |     | Аудио выход      |
| как программатор |     | BLE + Камера     |     | MP3 плеер        |
+------------------+     +------------------+     +------------------+
```

---

## 1. Прошивка ESP32-CAM через NodeMCU

ESP32-CAM не имеет USB порта, поэтому используем NodeMCU как USB-UART программатор.

### Схема подключения для прошивки:

```
    NodeMCU (ESP8266)              ESP32-CAM
    +-----------------+            +------------------+
    |                 |            |                  |
    |  3V3 ───────────┼────────────┤ 3V3              |
    |  GND ───────────┼────────────┤ GND              |
    |  TX  ───────────┼────────────┤ U0R (RX)         |
    |  RX  ───────────┼────────────┤ U0T (TX)         |
    |                 |            |                  |
    |  GND ───────────┼────────────┤ IO0 (для режима  |
    |                 |            |      прошивки)   |
    |  RST ───────────┼── к GND    |                  |
    |     (держать    |            |                  |
    |      в ресете)  |            |                  |
    +-----------------+            +------------------+
```

### Важно!
- **RST пин NodeMCU** должен быть подключен к GND (чтобы отключить ESP8266)
- **IO0 пин ESP32-CAM** должен быть подключен к GND для входа в режим прошивки
- После прошивки отключите IO0 от GND!

### Пошаговая инструкция:

1. Подключите провода по схеме выше
2. Подключите NodeMCU к USB ноутбука
3. В Arduino IDE выберите:
   - Плата: **AI Thinker ESP32-CAM**
   - Порт: ваш COM порт
4. Нажмите **Upload**
5. Когда увидите "Connecting...", нажмите **RST** на ESP32-CAM
6. После успешной прошивки **отключите IO0 от GND**
7. Нажмите RST для перезагрузки

---

## 2. Рабочая схема (после прошивки)

### ESP32-CAM + DFPlayer Mini + Динамик

```
                    ESP32-CAM                          DFPlayer Mini
                +---------------+                   +----------------+
                |               |                   |                |
    [5V]────────┤ 5V        GND├───────────────────┤GND             |
    [GND]───────┤ GND          |                   |                |
                |               |                   |    SPK_1 ──────┼──── [Динамик +]
                |          IO14├───────────────────┤RX              |
                |          IO15├───────────────────┤TX   SPK_2 ──────┼──── [Динамик -]
                |               |                   |                |
                |          IO4  │ (Flash LED)       |           VCC ─┼──── [5V]
                |               |                   |                |
                |          IO13 │ (Battery ADC)     +----------------+
                |               |
                |    [Камера]   |
                |   встроенная  |
                +---------------+
```

### Распиновка подключений:

| ESP32-CAM Pin | Подключить к | Назначение |
|--------------|--------------|------------|
| 5V | Питание 5V | Питание платы |
| GND | Общая земля | Земля |
| IO14 | DFPlayer RX | Передача команд |
| IO15 | DFPlayer TX | Получение статуса |
| IO4 | - | Встроенный Flash LED |
| IO13 | Делитель напряжения | Батарея (опционально) |

| DFPlayer Pin | Подключить к | Назначение |
|-------------|--------------|------------|
| VCC | 5V | Питание |
| GND | GND | Земля |
| RX | ESP32 IO14 | Команды |
| TX | ESP32 IO15 | Ответы |
| SPK_1 | Динамик + | Аудио выход |
| SPK_2 | Динамик - | Аудио выход |

---

## 3. Подготовка SD карты для DFPlayer

### Структура папок:

```
microSD (FAT32)
│
├── 01/                    # Папка системных звуков
│   ├── 001.mp3           # Звук подключения
│   ├── 002.mp3           # Звук отключения
│   ├── 003.mp3           # Звук ошибки
│   └── ...
│
├── 02/                    # Папка навигации
│   ├── 001.mp3           # "Поверните налево"
│   ├── 002.mp3           # "Поверните направо"
│   ├── 003.mp3           # "Двигайтесь прямо"
│   ├── 004.mp3           # "Вы прибыли"
│   └── ...
│
├── 03/                    # Папка предупреждений
│   ├── 001.mp3           # "Впереди препятствие"
│   ├── 002.mp3           # "Осторожно, ступенька"
│   └── ...
│
└── 04/                    # Папка уведомлений
    ├── 001.mp3           # "Новое сообщение"
    └── ...
```

### Важно для DFPlayer:
- Формат SD карты: **FAT32**
- Максимальный размер: **32GB**
- Папки называть: **01, 02, 03...**
- Файлы называть: **001.mp3, 002.mp3...**
- Формат аудио: **MP3** (рекомендуется 128kbps)

---

## 4. Полная схема проекта

```
                                   ┌─────────────────────────┐
                                   │     СМАРТФОН            │
                                   │   (Flutter App)         │
                                   │                         │
                                   │  ┌─────────────────┐    │
                                   │  │ Bluetooth BLE   │    │
                                   │  └────────┬────────┘    │
                                   └───────────┼─────────────┘
                                               │
                                               │ BLE
                                               │
                    ┌──────────────────────────┴──────────────────────────┐
                    │                    ESP32-CAM                         │
                    │                                                      │
                    │   ┌──────────┐  ┌──────────┐  ┌──────────────┐      │
                    │   │   BLE    │  │  Camera  │  │   UART       │      │
                    │   │  Server  │  │  OV2640  │  │  Controller  │      │
                    │   └──────────┘  └──────────┘  └──────┬───────┘      │
                    │                                      │              │
                    └──────────────────────────────────────┼──────────────┘
                                                           │
                                                           │ UART (9600)
                                                           │
                    ┌──────────────────────────────────────┴──────────────┐
                    │                 DFPlayer Mini                        │
                    │                                                      │
                    │   ┌──────────┐  ┌──────────┐  ┌──────────────┐      │
                    │   │  MP3     │  │  microSD │  │  Amplifier   │      │
                    │   │  Decoder │  │  Reader  │  │              │      │
                    │   └──────────┘  └──────────┘  └──────┬───────┘      │
                    │                                      │              │
                    └──────────────────────────────────────┼──────────────┘
                                                           │
                                                           │
                                                    ┌──────┴──────┐
                                                    │   Динамик   │
                                                    │   (3W 8Ω)   │
                                                    └─────────────┘
```

---

## 5. Питание

### Варианты питания:

**Вариант 1: От USB (для тестирования)**
- Подключите ESP32-CAM к USB через программатор
- DFPlayer питается от 5V ESP32-CAM

**Вариант 2: От батареи (для автономной работы)**
```
Li-Po 3.7V ─── Boost Converter (5V) ─── ESP32-CAM 5V
                     │
                     └─── DFPlayer VCC
```

**Вариант 3: Power Bank**
- Просто подключите через USB

---

## 6. Тестирование

После сборки:

1. Включите питание
2. Откройте Serial Monitor (115200 baud)
3. Должны увидеть:
   ```
   === Smart Glasses ESP32-CAM ===
   [DFPLAYER] Initializing...
   [DFPLAYER] Ready
   [CAM] Initializing...
   [CAM] Initialized successfully
   [BLE] Initializing...
   [BLE] Ready! Device name: SmartGlasses
   === Ready for connections! ===
   ```
4. Откройте приложение на телефоне
5. Перейдите в раздел подключения устройства
6. Найдите "SmartGlasses" в списке
7. Подключитесь!

---

## 7. Устранение проблем

| Проблема | Решение |
|----------|---------|
| ESP32-CAM не прошивается | Убедитесь что IO0 подключен к GND, нажмите RST |
| Нет звука из DFPlayer | Проверьте SD карту (FAT32), формат файлов |
| BLE не найден | Включите Bluetooth и геолокацию на телефоне |
| Камера не работает | Проверьте шлейф камеры |
| Прошивка зависает на "Connecting..." | Нажмите кнопку RST на ESP32-CAM |
